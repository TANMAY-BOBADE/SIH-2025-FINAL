#include <WiFi.h>
#include <ESP32Servo.h>
#include <DHT.h>
#include <FirebaseESP32.h>

// =================== WIFI ===================
const char* ssid = "wifi";         // REPLACE WITH YOUR WIFI NAME
const char* password = "12345678"; // REPLACE WITH YOUR PASSWORD

// =================== FIREBASE ===================
#define DATABASE_URL "https://kissan-agriculture-sih-default-rtdb.asia-southeast1.firebasedatabase.app"
#define DATABASE_SECRET "RudAdT0IW4GEPXx3kT8SH0CoqqpQYjC9ItfkNzdS"

// =================== HARDWARE PINS ===================
#define DISC_SERVO_PIN 13
#define FLAP_SERVO_PIN 15

// RACK MOTORS (Updated to your specific pinout)
#define MOTOR_A_FWD 27
#define MOTOR_A_BWD 26
#define MOTOR_B_FWD 25
#define MOTOR_B_BWD 33
#define MOTOR_ENA 14
#define MOTOR_ENB 32

// SENSORS & PUMP
#define DHTPIN 4
#define DHTTYPE DHT11
#define SOIL_MOISTURE_PIN 34
#define PUMP_RELAY_PIN 12

// =================== SETTINGS ===================
#define SERVO_STOP_VAL 90 
#define RELAY_ON_LOGIC HIGH
#define RELAY_OFF_LOGIC LOW
#define DISC_STEP_TIME 300 

// Pump Calc: ~100 L/H => 0.0277 mL/ms
const float PUMP_FLOW_RATE_MS = 0.0277; 
const float WATER_PER_PERCENT = 10.0; // Calibration: mL needed per 1% deficit

// =================== OBJECTS ===================
Servo discServo;
Servo flapServo;
DHT dht(DHTPIN, DHTTYPE);
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

// =================== VARIABLES ===================
float calculatedDuration = 0; 

void setup() {
  Serial.begin(115200);
  Serial.println("\nğŸŒ¾ Kissan Agriculture Rover System Starting...");

  // PINS
  pinMode(MOTOR_A_FWD, OUTPUT); pinMode(MOTOR_A_BWD, OUTPUT);
  pinMode(MOTOR_B_FWD, OUTPUT); pinMode(MOTOR_B_BWD, OUTPUT);
  pinMode(MOTOR_ENA, OUTPUT); pinMode(MOTOR_ENB, OUTPUT);
  pinMode(PUMP_RELAY_PIN, OUTPUT);
  digitalWrite(PUMP_RELAY_PIN, RELAY_OFF_LOGIC);

  // SERVOS
  discServo.setPeriodHertz(50); 
  discServo.attach(DISC_SERVO_PIN, 500, 2400);
  flapServo.setPeriodHertz(50); 
  flapServo.attach(FLAP_SERVO_PIN, 500, 2400);
  discServo.write(SERVO_STOP_VAL);
  flapServo.write(0); // Closed
  Serial.println("âœ… Servos initialized");

  dht.begin();
  Serial.println("âœ… DHT11 sensor initialized");

  // WIFI
  Serial.print("ğŸ“¡ Connecting to WiFi");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) { 
    delay(300); 
    Serial.print("."); 
  }
  Serial.println("\nâœ… WiFi Connected!");
  Serial.print("ğŸ“ IP Address: ");
  Serial.println(WiFi.localIP());

  // FIREBASE
  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;
  firebaseData.setBSSLBufferSize(2048, 1024);
  firebaseData.setResponseSize(2048);
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  Serial.println("âœ… Firebase connected!");
  
  // Initialize Firebase status
  Firebase.setString(firebaseData, "/rover/status", "READY");
  Firebase.setString(firebaseData, "/rover/controls/manual_cmd", "IDLE");
  
  Serial.println("ğŸš€ System Ready! Waiting for commands...\n");
}

void loop() {
  unsigned long currentMillis = millis();
  static unsigned long lastCheck = 0;
  static unsigned long lastSensorUpdate = 0;

  // 1. POLL COMMANDS (Check every 200ms)
  if (Firebase.ready() && (currentMillis - lastCheck > 200)) {
    lastCheck = currentMillis;
    
    if (Firebase.getString(firebaseData, "/rover/controls/manual_cmd")) {
      String cmd = firebaseData.stringData();
      
      // Execute ANY non-IDLE command
      if (cmd != "IDLE" && cmd != "") {
        Serial.println("ğŸ”” New Command Detected: " + cmd);
        executeCommand(cmd);
        
        // Immediately reset to IDLE after execution starts
        Firebase.setString(firebaseData, "/rover/controls/manual_cmd", "IDLE");
      }
    }
  }

  // 2. UPDATE SENSORS TO FIREBASE (Every 5 seconds)
  if (currentMillis - lastSensorUpdate > 5000) {
    lastSensorUpdate = currentMillis;
    updateSensors();
  }
  
  // NOTE: Pump Timer removed from loop. Logic is now blocking in STEP 7.
}

void executeCommand(String cmd) {
  Serial.println("âš¡ Executing: " + cmd);
  
  // Update Firebase status
  Firebase.setString(firebaseData, "/rover/status", cmd);

  // --- STEP 1: SEED DROP ---
  if (cmd == "STEP1") {
    Serial.println("ğŸŒ± STEP 1: Dropping Seed...");
    discServo.write(180); 
    delay(DISC_STEP_TIME); 
    discServo.write(SERVO_STOP_VAL);
    Serial.println("âœ… Seed dropped successfully!");
  }

  // --- STEP 2: RACK DOWN ---
  else if (cmd == "RACK_DOWN") {
    Serial.println("â¬‡ STEP 2: Moving Rack DOWN...");
    digitalWrite(MOTOR_A_FWD, LOW); 
    digitalWrite(MOTOR_A_BWD, HIGH);
    digitalWrite(MOTOR_B_FWD, HIGH); 
    digitalWrite(MOTOR_B_BWD, LOW);
    digitalWrite(MOTOR_ENA, HIGH);  
    digitalWrite(MOTOR_ENB, HIGH);
    Serial.println("ğŸ”„ Rack motors running DOWN (Hold button to continue)");
  }

  // --- STEP 3: OPEN FLAP ---
  else if (cmd == "STEP3_FLAP_OPEN") {
    Serial.println("ğŸšª STEP 3: Opening Flap...");
    flapServo.write(90); 
    Serial.println("âœ… Flap opened (90Â°)");
  }

  // --- STEP 4: SENSE & CALCULATE ---
  else if (cmd == "STEP4_SENSE") {
    Serial.println("ğŸ§  STEP 4: Sensing Environment & Calculating Water Needs...");
    Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

    // 1. Get Selected Crop & Stage
    String crop = "", stage = "";
    if(Firebase.getString(firebaseData, "/rover/selected_crop")) {
      crop = firebaseData.stringData();
    }
    if(Firebase.getString(firebaseData, "/rover/selected_stage")) {
      stage = firebaseData.stringData();
    }

    if(crop == "" || stage == "") { 
      Serial.println("âŒ ERROR: No crop/stage selected in dashboard!");
      Serial.println("ğŸ‘‰ Please select crop and stage first");
      return; 
    }

    // 2. Build Database Path
    String basePath = "/crops/" + crop + "/stages/" + stage;
    Serial.println("ğŸ“‚ Reading from: " + basePath);
    
    // 3. Fetch Thresholds from Database
    float db_moist_min = 0, db_temp_max = 0, db_hum_max = 0;
    
    if(Firebase.getFloat(firebaseData, basePath + "/moisture_min")) {
      db_moist_min = firebaseData.floatData();
    }
    if(Firebase.getFloat(firebaseData, basePath + "/temp_max")) {
      db_temp_max = firebaseData.floatData();
    }
    if(Firebase.getFloat(firebaseData, basePath + "/humidity_max")) {
      db_hum_max = firebaseData.floatData();
    }

    // 4. Read Current Sensors
    float h = dht.readHumidity();
    float t = dht.readTemperature();
    float rawM = analogRead(SOIL_MOISTURE_PIN);
    // USING YOUR CALIBRATED MAPPING:
    float m = map(rawM, 3200, 2670, 0, 100); 
    m = constrain(m, 0, 100);

    // 5. Display Results
    Serial.println("\nğŸ“Š ANALYSIS RESULTS:");
    Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    Serial.printf("ğŸŒ¾ Crop: %s\n", crop.c_str());
    Serial.printf("ğŸ“ˆ Stage: %s\n", stage.c_str());
    Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    Serial.printf("ğŸŒ¡  Temperature: %.1fÂ°C (Max Limit: %.1fÂ°C) ", t, db_temp_max);
    if(t > db_temp_max) Serial.println("âš  HIGH");
    else Serial.println("âœ… OK");
    
    Serial.printf("ğŸ’§ Humidity: %.1f%% (Max Limit: %.1f%%) ", h, db_hum_max);
    if(h > db_hum_max) Serial.println("âš  HIGH");
    else Serial.println("âœ… OK");
    
    Serial.printf("ğŸŒ± Soil Moisture: %.1f%% (Min Required: %.1f%%) ", m, db_moist_min);
    if(m < db_moist_min) Serial.println("âš  LOW - NEEDS WATER");
    else Serial.println("âœ… SUFFICIENT");
    Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

    // 6. Calculate Water Duration
    if (m < db_moist_min) {
      float deficit = db_moist_min - m;
      float waterNeeded = deficit * WATER_PER_PERCENT;
      calculatedDuration = waterNeeded / PUMP_FLOW_RATE_MS;
      
      // Apply safety limits
      calculatedDuration = constrain(calculatedDuration, 1000, 10000);
      
      Serial.println("\nğŸ’¡ WATER CALCULATION:");
      Serial.printf("   Moisture Deficit: %.1f%%\n", deficit);
      Serial.printf("   Water Needed: %.1f mL\n", waterNeeded);
      Serial.printf("   â±  Pump Duration: %.0f ms (%.1f seconds)\n", calculatedDuration, calculatedDuration/1000.0);
      Serial.println("âœ… Ready for Step 7 (Watering)");
      
      // Store in Firebase for dashboard display
      Firebase.setFloat(firebaseData, "/rover/plantation/water_duration_calculated", calculatedDuration);
    } else {
      calculatedDuration = 0;
      Serial.println("\nâœ… Soil moisture is sufficient!");
      Serial.println("â„¹  No watering needed for this location");
      Firebase.setFloat(firebaseData, "/rover/plantation/water_duration_calculated", 0);
    }
    Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
  }

  // --- STEP 5: CLOSE FLAP ---
  else if (cmd == "STEP5_FLAP_CLOSE") {
    Serial.println("ğŸšª STEP 5: Closing Flap...");
    flapServo.write(0);
    Serial.println("âœ… Flap closed (0Â°)");
  }

  // --- STEP 6: RACK UP ---
  else if (cmd == "RACK_UP") {
    Serial.println("â¬† STEP 6: Moving Rack UP...");
    digitalWrite(MOTOR_A_FWD, HIGH); 
    digitalWrite(MOTOR_A_BWD, LOW);
    digitalWrite(MOTOR_B_FWD, LOW); 
    digitalWrite(MOTOR_B_BWD, HIGH);
    digitalWrite(MOTOR_ENA, HIGH);  
    digitalWrite(MOTOR_ENB, HIGH);
    Serial.println("ğŸ”„ Rack motors running UP (Hold button to continue)");
  }

  // --- STOP RACK ---
  else if (cmd == "RACK_STOP") {
    Serial.println("â¸ RACK STOP: Stopping all rack motors...");
    digitalWrite(MOTOR_ENA, LOW); 
    digitalWrite(MOTOR_ENB, LOW);
    digitalWrite(MOTOR_A_FWD, LOW); 
    digitalWrite(MOTOR_A_BWD, LOW);
    digitalWrite(MOTOR_B_FWD, LOW); 
    digitalWrite(MOTOR_B_BWD, LOW);
    Serial.println("âœ… Rack motors stopped");
  }

  // --- STEP 7: START WATERING (BLOCKING LOGIC) ---
  else if (cmd == "STEP7_WATER") {
    Serial.println("ğŸ’¦ STEP 7: Starting Watering Process...");
    
    if (calculatedDuration > 0) {
      Serial.printf("â±  Starting pump for %.0f ms (%.1f seconds)\n", calculatedDuration, calculatedDuration/1000.0);
      
      // 1. Turn Pump ON
      digitalWrite(PUMP_RELAY_PIN, RELAY_ON_LOGIC);
      Firebase.setString(firebaseData, "/rover/status", "WATERING");
      Serial.println("âœ… Pump ON - Waiting...");

      // 2. BLOCKING DELAY (Stops execution to ensure pump stays on)
      delay(calculatedDuration);

      // 3. Turn Pump OFF
      digitalWrite(PUMP_RELAY_PIN, RELAY_OFF_LOGIC);
      Serial.println("ğŸ›‘ Pump OFF - Watering Complete!");
      
      // 4. Auto-Close Flap & Update Status
      flapServo.write(0);
      Serial.println("ğŸšª Flap auto-closed");
      Firebase.setString(firebaseData, "/rover/status", "WATERING_COMPLETE");

    } else {
      Serial.println("âš  ERROR: No water duration calculated!");
      Serial.println("ğŸ‘‰ Please run STEP 4 (Sense & Calculate) first");
      Firebase.setString(firebaseData, "/rover/status", "ERROR_NO_CALC");
    }
  }

  // --- UNKNOWN COMMAND ---
  else {
    Serial.println("âŒ Unknown command: " + cmd);
  }
}

void updateSensors() {
  float h = dht.readHumidity();
  float t = dht.readTemperature();
  float rawM = analogRead(SOIL_MOISTURE_PIN);
  float m = map(rawM, 3200, 2670, 0, 100);
  m = constrain(m, 0, 100);

  // Check for sensor errors
  if (isnan(h) || isnan(t)) {
    Serial.println("âš  DHT sensor read failed!");
    return;
  }

  // Update Firebase
  Firebase.setFloat(firebaseData, "/rover/sensors/temperature", t);
  Firebase.setFloat(firebaseData, "/rover/sensors/humidity", h);
  Firebase.setFloat(firebaseData, "/rover/sensors/moisture", m);
  Firebase.setInt(firebaseData, "/rover/sensors/timestamp", millis());

  // Print to serial (optional - comment out to reduce spam)
  Serial.printf("ğŸ“Š Sensors: T=%.1fÂ°C, H=%.1f%%, M=%.1f%%\n", t, h, m);
}
