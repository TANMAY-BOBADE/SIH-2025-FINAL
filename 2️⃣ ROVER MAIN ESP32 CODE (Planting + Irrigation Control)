#include <WiFi.h>
#include <WebServer.h>
#include <ESP32Servo.h>
#include <DHT.h>
#include <FirebaseESP32.h>

// =================== WIFI CREDENTIALS (YOUR MOBILE HOTSPOT) ===================
const char* ssid = "YOUR_MOBILE_HOTSPOT_NAME";     // Change this!
const char* password = "YOUR_HOTSPOT_PASSWORD";    // Change this!

// =================== FIREBASE ===================
#define DATABASE_URL "https://kissan-agriculture-sih-default-rtdb.asia-southeast1.firebasedatabase.app"
#define DATABASE_SECRET "YOUR_DATABASE_SECRET_HERE"

// =================== PINS ===================
#define DISC_SERVO_PIN 13
#define FLAP_SERVO_PIN 15
#define MOTOR_A_FWD 26
#define MOTOR_A_BWD 27
#define MOTOR_B_FWD 14
#define MOTOR_B_BWD 12
#define MOTOR_ENA 25
#define MOTOR_ENB 33
#define DHTPIN 4
#define DHTTYPE DHT11
#define SOIL_MOISTURE_PIN 34
#define PUMP_RELAY_PIN 32

// =================== OBJECTS ===================
Servo discServo;
Servo flapServo;
DHT dht(DHTPIN, DHTTYPE);
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

// =================== VARIABLES ===================
int currentDiscAngle = 0;
bool plantationRunning = false;
bool irrigationRunning = false;
unsigned long sequenceStartTime = 0;
int plantationStep = 0;
float calculatedWaterDuration = 0;
float soilMoistureReading = 0;
String selectedCrop = "potato";
String selectedStage = "germination";

struct Thresholds {
  float moisture_min;
  float moisture_max;
  float temp_min;
  float temp_max;
} currentThresholds = {48, 70, 8, 30};

unsigned long lastSensorUpload = 0;
unsigned long lastCommandCheck = 0;
const unsigned long SENSOR_INTERVAL = 7000;
const unsigned long COMMAND_CHECK_INTERVAL = 500; // Check commands every 0.5 seconds

void setup() {
  Serial.begin(115200);
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘    ROVER MAIN CONTROLLER           â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  pinMode(MOTOR_A_FWD, OUTPUT);
  pinMode(MOTOR_A_BWD, OUTPUT);
  pinMode(MOTOR_B_FWD, OUTPUT);
  pinMode(MOTOR_B_BWD, OUTPUT);
  pinMode(MOTOR_ENA, OUTPUT);
  pinMode(MOTOR_ENB, OUTPUT);
  pinMode(PUMP_RELAY_PIN, OUTPUT);
  
  digitalWrite(PUMP_RELAY_PIN, LOW);
  
  discServo.attach(DISC_SERVO_PIN);
  flapServo.attach(FLAP_SERVO_PIN);
  
  discServo.write(90);
  flapServo.write(0);
  
  dht.begin();
  
  // Connect to mobile hotspot
  Serial.println("\nğŸ“± Connecting to mobile hotspot...");
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ“ WiFi Connected!");
    Serial.print("âœ“ IP Address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nâœ— WiFi connection failed!");
    Serial.println("âš ï¸ Check hotspot name and password!");
  }
  
  initFirebase();
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘         SYSTEM READY               â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
  unsigned long currentMillis = millis();
  
  // Check WiFi connection
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âš ï¸ WiFi disconnected! Reconnecting...");
    WiFi.reconnect();
    delay(5000);
  }
  
  // Upload sensors every 7 seconds
  if (currentMillis - lastSensorUpload >= SENSOR_INTERVAL) {
    lastSensorUpload = currentMillis;
    uploadSensorData();
  }
  
  // Check Firebase commands frequently (every 0.5s for responsive control)
  if (currentMillis - lastCommandCheck >= COMMAND_CHECK_INTERVAL) {
    lastCommandCheck = currentMillis;
    checkFirebaseCommands();
  }
  
  // Handle automated sequences
  if (plantationRunning) {
    runPlantationSequence();
  }
  
  if (irrigationRunning) {
    runIrrigationSequence();
  }
}

void initFirebase() {
  Serial.println("ğŸ”¥ Initializing Firebase...");
  
  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  
  // Test connection
  if (Firebase.setString(firebaseData, "/rover/status", "ONLINE")) {
    Serial.println("âœ“ Firebase connected!");
  } else {
    Serial.println("âœ— Firebase connection failed!");
    Serial.println("Error: " + firebaseData.errorReason());
  }
}

void checkFirebaseCommands() {
  // Check selected crop & stage
  if (Firebase.getString(firebaseData, "/rover/selected_crop")) {
    String newCrop = firebaseData.stringData();
    if (newCrop != selectedCrop) {
      selectedCrop = newCrop;
      Serial.println("ğŸ“‹ Crop changed to: " + selectedCrop);
    }
  }
  
  if (Firebase.getString(firebaseData, "/rover/selected_stage")) {
    String newStage = firebaseData.stringData();
    if (newStage != selectedStage) {
      selectedStage = newStage;
      Serial.println("ğŸ“‹ Stage changed to: " + selectedStage);
    }
  }
  
  // Check movement commands
  if (Firebase.getString(firebaseData, "/rover/controls/movement")) {
    String movement = firebaseData.stringData();
    executeMovement(movement);
  }
  
  // Check plantation command
  if (Firebase.getBool(firebaseData, "/rover/controls/plantation_active")) {
    bool shouldStart = firebaseData.boolData();
    if (shouldStart && !plantationRunning) {
      startPlantationSequence();
      // Clear the command
      Firebase.setBool(firebaseData, "/rover/controls/plantation_active", false);
    }
  }
  
  // Check irrigation command
  if (Firebase.getBool(firebaseData, "/rover/controls/irrigation_active")) {
    bool shouldStart = firebaseData.boolData();
    if (shouldStart && !irrigationRunning) {
      startIrrigationSequence();
      // Clear the command
      Firebase.setBool(firebaseData, "/rover/controls/irrigation_active", false);
    }
  }
}

void executeMovement(String direction) {
  // This ESP32 doesn't control motors directly
  // It just passes command to ESP8266 via Firebase
  // ESP8266 will read /rover/controls/movement and act
  Serial.println("Movement: " + direction);
}

void uploadSensorData() {
  float temp = dht.readTemperature();
  float humidity = dht.readHumidity();
  float moisture = readSoilMoisture();
  
  if (isnan(temp) || isnan(humidity)) {
    Serial.println("âœ— Sensor failed");
    return;
  }
  
  Serial.printf("ğŸ“Š Rover: T=%.1fÂ°C H=%.1f%% M=%.1f%%\n", temp, humidity, moisture);
  
  Firebase.setFloat(firebaseData, "/rover/sensors/temperature", temp);
  Firebase.setFloat(firebaseData, "/rover/sensors/humidity", humidity);
  Firebase.setFloat(firebaseData, "/rover/sensors/moisture", moisture);
  Firebase.setInt(firebaseData, "/rover/sensors/timestamp", millis());
}

float readSoilMoisture() {
  int rawValue = analogRead(SOIL_MOISTURE_PIN);
  float moisture = map(rawValue, 3000, 1000, 0, 100);
  moisture = constrain(moisture, 0, 100);
  return moisture;
}

void startPlantationSequence() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘   PLANTATION SEQUENCE STARTED      â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  plantationRunning = true;
  plantationStep = 1;
  sequenceStartTime = millis();
  
  Firebase.setBool(firebaseData, "/rover/plantation/sequence_running", true);
  Firebase.setInt(firebaseData, "/rover/plantation/current_step", 1);
}

void runPlantationSequence() {
  unsigned long elapsed = millis() - sequenceStartTime;
  
  switch (plantationStep) {
    case 1:
      Serial.println("Step 1/5: Rack DOWN â†“");
      moveRackDown();
      sequenceStartTime = millis();
      plantationStep = 2;
      Firebase.setInt(firebaseData, "/rover/plantation/current_step", 2);
      break;
      
    case 2:
      if (elapsed >= 500) {
        Serial.println("Step 2/5: Disc ROTATE 60Â° âŸ²");
        rotateDisc60Degrees();
        sequenceStartTime = millis();
        plantationStep = 3;
        Firebase.setInt(firebaseData, "/rover/plantation/current_step", 3);
      }
      break;
      
    case 3:
      if (elapsed >= 500) {
        Serial.println("Step 3/5: Flap OPEN (sensor immersed) ğŸ“");
        flapServo.write(90);
        soilMoistureReading = readSoilMoisture();
        Serial.printf("   â””â”€ Soil moisture: %.1f%%\n", soilMoistureReading);
        calculateWaterDuration();
        sequenceStartTime = millis();
        plantationStep = 4;
        Firebase.setInt(firebaseData, "/rover/plantation/current_step", 4);
      }
      break;
      
    case 4:
      if (elapsed >= 8000) {
        Serial.println("Step 4/5: Flap CLOSE ğŸ”’");
        flapServo.write(0);
        sequenceStartTime = millis();
        plantationStep = 5;
        Firebase.setInt(firebaseData, "/rover/plantation/current_step", 5);
      }
      break;
      
    case 5:
      if (elapsed >= 500) {
        Serial.println("Step 5/5: Rack UP â†‘");
        moveRackUp();
        sequenceStartTime = millis();
        plantationStep = 6;
      }
      break;
      
    case 6:
      if (elapsed >= 2000) {
        Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        Serial.println("â•‘  PLANTATION COMPLETE âœ“             â•‘");
        Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
        stopMotors();
        plantationRunning = false;
        plantationStep = 0;
        Firebase.setBool(firebaseData, "/rover/plantation/sequence_running", false);
        Firebase.setFloat(firebaseData, "/rover/plantation/water_duration_calculated", calculatedWaterDuration);
      }
      break;
  }
}

void startIrrigationSequence() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘      IRRIGATION STARTED            â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.printf("ğŸ’§ Watering for %.1f seconds\n", calculatedWaterDuration / 1000.0);
  
  irrigationRunning = true;
  digitalWrite(PUMP_RELAY_PIN, HIGH);
  sequenceStartTime = millis();
  
  Firebase.setBool(firebaseData, "/rover/plantation/irrigation_active", true);
}

void runIrrigationSequence() {
  unsigned long elapsed = millis() - sequenceStartTime;
  
  if (elapsed >= calculatedWaterDuration) {
    Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘   IRRIGATION COMPLETE âœ“            â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    digitalWrite(PUMP_RELAY_PIN, LOW);
    irrigationRunning = false;
    Firebase.setBool(firebaseData, "/rover/plantation/irrigation_active", false);
  }
}

void moveRackDown() {
  digitalWrite(MOTOR_A_FWD, LOW);
  digitalWrite(MOTOR_A_BWD, HIGH);
  digitalWrite(MOTOR_B_FWD, HIGH);
  digitalWrite(MOTOR_B_BWD, LOW);
  analogWrite(MOTOR_ENA, 255);
  analogWrite(MOTOR_ENB, 255);
}

void moveRackUp() {
  digitalWrite(MOTOR_A_FWD, HIGH);
  digitalWrite(MOTOR_A_BWD, LOW);
  digitalWrite(MOTOR_B_FWD, LOW);
  digitalWrite(MOTOR_B_BWD, HIGH);
  analogWrite(MOTOR_ENA, 255);
  analogWrite(MOTOR_ENB, 255);
}

void stopMotors() {
  digitalWrite(MOTOR_A_FWD, LOW);
  digitalWrite(MOTOR_A_BWD, LOW);
  digitalWrite(MOTOR_B_FWD, LOW);
  digitalWrite(MOTOR_B_BWD, LOW);
}

void rotateDisc60Degrees() {
  discServo.write(180);
  delay(300);
  discServo.write(90);
  currentDiscAngle = (currentDiscAngle + 60) % 360;
}

void calculateWaterDuration() {
  String basePath = "/crops/" + selectedCrop + "/stages/" + selectedStage;
  
  if (Firebase.getFloat(firebaseData, basePath + "/moisture_min")) {
    currentThresholds.moisture_min = firebaseData.floatData();
  }
  if (Firebase.getFloat(firebaseData, basePath + "/moisture_max")) {
    currentThresholds.moisture_max = firebaseData.floatData();
  }
  
  float targetMoisture = (currentThresholds.moisture_min + currentThresholds.moisture_max) / 2.0;
  float deficit = targetMoisture - soilMoistureReading;
  
  if (deficit <= 0) {
    Serial.println("   â””â”€ Soil moisture adequate, no watering needed");
    calculatedWaterDuration = 0;
    return;
  }
  
  float waterNeeded = deficit * 0.05;
  float pumpRate = 0.028;
  calculatedWaterDuration = (waterNeeded / pumpRate) * 1000;
  
  calculatedWaterDuration = constrain(calculatedWaterDuration, 1000, 30000);
  
  Serial.printf("   â””â”€ Water needed: %.1fs (deficit: %.1f%%)\n", 
                calculatedWaterDuration / 1000.0, deficit);
}
