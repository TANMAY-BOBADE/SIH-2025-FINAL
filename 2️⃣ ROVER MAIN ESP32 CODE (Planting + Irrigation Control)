#include <WiFi.h>
#include <WebServer.h>
#include <ESP32Servo.h>
#include <DHT.h>
#include <FirebaseESP32.h>

// =================== WIFI HOTSPOT ===================
const char* ssid = "AgriRover";
const char* password = "rover123";

// =================== FIREBASE ===================
#define DATABASE_URL "https://kissan-agriculture-sih-default-rtdb.asia-southeast1.firebasedatabase.app"
#define DATABASE_SECRET "YOUR_DATABASE_SECRET_HERE"

// =================== PINS ===================
#define DISC_SERVO_PIN 13
#define FLAP_SERVO_PIN 15
#define MOTOR_A_FWD 26
#define MOTOR_A_BWD 27
#define MOTOR_B_FWD 14
#define MOTOR_B_BWD 12
#define MOTOR_ENA 25
#define MOTOR_ENB 33
#define DHTPIN 4
#define DHTTYPE DHT11
#define SOIL_MOISTURE_PIN 34
#define PUMP_RELAY_PIN 32

// =================== OBJECTS ===================
Servo discServo;
Servo flapServo;
DHT dht(DHTPIN, DHTTYPE);
WebServer server(80);
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

// =================== VARIABLES ===================
int currentDiscAngle = 0;
bool plantationRunning = false;
bool irrigationRunning = false;
unsigned long sequenceStartTime = 0;
int plantationStep = 0;
float calculatedWaterDuration = 0;
float soilMoistureReading = 0;
String selectedCrop = "potato";
String selectedStage = "germination";

struct Thresholds {
  float moisture_min;
  float moisture_max;
  float temp_min;
  float temp_max;
} currentThresholds = {48, 70, 8, 30};

unsigned long lastSensorUpload = 0;
const unsigned long SENSOR_INTERVAL = 7000;

void setup() {
  Serial.begin(115200);
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘    ROVER MAIN CONTROLLER           â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  pinMode(MOTOR_A_FWD, OUTPUT);
  pinMode(MOTOR_A_BWD, OUTPUT);
  pinMode(MOTOR_B_FWD, OUTPUT);
  pinMode(MOTOR_B_BWD, OUTPUT);
  pinMode(MOTOR_ENA, OUTPUT);
  pinMode(MOTOR_ENB, OUTPUT);
  pinMode(PUMP_RELAY_PIN, OUTPUT);
  
  digitalWrite(PUMP_RELAY_PIN, LOW);
  
  discServo.attach(DISC_SERVO_PIN);
  flapServo.attach(FLAP_SERVO_PIN);
  
  discServo.write(90);
  flapServo.write(0);
  
  dht.begin();
  
  WiFi.softAP(ssid, password);
  IPAddress IP = WiFi.softAPIP();
  
  Serial.println("\nâœ“ WiFi Hotspot: " + String(ssid));
  Serial.println("âœ“ Password: " + String(password));
  Serial.println("âœ“ IP Address: " + IP.toString());
  
  setupRoutes();
  server.begin();
  Serial.println("âœ“ Web server started");
  
  initFirebase();
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘         SYSTEM READY               â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
  server.handleClient();
  
  unsigned long currentMillis = millis();
  
  if (currentMillis - lastSensorUpload >= SENSOR_INTERVAL) {
    lastSensorUpload = currentMillis;
    uploadSensorData();
  }
  
  checkFirebaseCommands();
  
  if (plantationRunning) {
    runPlantationSequence();
  }
  
  if (irrigationRunning) {
    runIrrigationSequence();
  }
}

void initFirebase() {
  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  Serial.println("ğŸ”¥ Firebase initialized");
}

void checkFirebaseCommands() {
  // Check for commands from dashboard
  if (Firebase.getString(firebaseData, "/rover/selected_crop")) {
    selectedCrop = firebaseData.stringData();
  }
  
  if (Firebase.getString(firebaseData, "/rover/selected_stage")) {
    selectedStage = firebaseData.stringData();
  }
  
  // Check for plantation/irrigation commands
  if (Firebase.getBool(firebaseData, "/rover/controls/plantation_active")) {
    bool shouldStart = firebaseData.boolData();
    if (shouldStart && !plantationRunning) {
      startPlantationSequence();
      Firebase.setBool(firebaseData, "/rover/controls/plantation_active", false);
    }
  }
  
  if (Firebase.getBool(firebaseData, "/rover/controls/irrigation_active")) {
    bool shouldStart = firebaseData.boolData();
    if (shouldStart && !irrigationRunning) {
      startIrrigationSequence();
      Firebase.setBool(firebaseData, "/rover/controls/irrigation_active", false);
    }
  }
}

void uploadSensorData() {
  float temp = dht.readTemperature();
  float humidity = dht.readHumidity();
  float moisture = readSoilMoisture();
  
  if (isnan(temp) || isnan(humidity)) {
    Serial.println("âœ— Sensor failed");
    return;
  }
  
  Serial.printf("ğŸ“Š Rover: T=%.1fÂ°C H=%.1f%% M=%.1f%%\n", temp, humidity, moisture);
  
  Firebase.setFloat(firebaseData, "/rover/sensors/temperature", temp);
  Firebase.setFloat(firebaseData, "/rover/sensors/humidity", humidity);
  Firebase.setFloat(firebaseData, "/rover/sensors/moisture", moisture);
  Firebase.setInt(firebaseData, "/rover/sensors/timestamp", millis());
}

float readSoilMoisture() {
  int rawValue = analogRead(SOIL_MOISTURE_PIN);
  float moisture = map(rawValue, 3000, 1000, 0, 100);
  moisture = constrain(moisture, 0, 100);
  return moisture;
}

void setupRoutes() {
  server.on("/rover/move/forward", HTTP_GET, []() {
    Serial.println("â†’ Forward");
    sendJSONResponse(200, "success", "forward");
  });
  
  server.on("/rover/move/backward", HTTP_GET, []() {
    Serial.println("â† Backward");
    sendJSONResponse(200, "success", "backward");
  });
  
  server.on("/rover/move/left", HTTP_GET, []() {
    Serial.println("â†º Left");
    sendJSONResponse(200, "success", "left");
  });
  
  server.on("/rover/move/right", HTTP_GET, []() {
    Serial.println("â†» Right");
    sendJSONResponse(200, "success", "right");
  });
  
  server.on("/rover/stop", HTTP_GET, []() {
    Serial.println("â¹ Stop");
    sendJSONResponse(200, "success", "stop");
  });
  
  server.on("/rover/plant/start", HTTP_GET, []() {
    if (!plantationRunning) {
      startPlantationSequence();
      sendJSONResponse(200, "success", "Plantation started");
    } else {
      sendJSONResponse(400, "error", "Already running");
    }
  });
  
  server.on("/rover/irrigate/start", HTTP_GET, []() {
    if (!irrigationRunning) {
      startIrrigationSequence();
      sendJSONResponse(200, "success", "Irrigation started");
    } else {
      sendJSONResponse(400, "error", "Already watering");
    }
  });
  
  server.on("/rover/status", HTTP_GET, []() {
    String json = "{";
    json += "\"plantation_active\":" + String(plantationRunning ? "true" : "false") + ",";
    json += "\"irrigation_active\":" + String(irrigationRunning ? "true" : "false") + ",";
    json += "\"disc_angle\":" + String(currentDiscAngle) + ",";
    json += "\"soil_moisture\":" + String(soilMoistureReading);
    json += "}";
    server.send(200, "application/json", json);
  });
  
  server.enableCORS(true);
}

void sendJSONResponse(int code, String status, String message) {
  String json = "{\"status\":\"" + status + "\",\"message\":\"" + message + "\"}";
  server.send(code, "application/json", json);
}

void startPlantationSequence() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘   PLANTATION SEQUENCE STARTED      â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  plantationRunning = true;
  plantationStep = 1;
  sequenceStartTime = millis();
  
  Firebase.setBool(firebaseData, "/rover/plantation/sequence_running", true);
  Firebase.setInt(firebaseData, "/rover/plantation/current_step", 1);
}

void runPlantationSequence() {
  unsigned long elapsed = millis() - sequenceStartTime;
  
  switch (plantationStep) {
    case 1:
      Serial.println("Step 1/5: Rack DOWN â†“");
      moveRackDown();
      sequenceStartTime = millis();
      plantationStep = 2;
      Firebase.setInt(firebaseData, "/rover/plantation/current_step", 2);
      break;
      
    case 2:
      if (elapsed >= 500) {
        Serial.println("Step 2/5: Disc ROTATE 60Â° âŸ²");
        rotateDisc60Degrees();
        sequenceStartTime = millis();
        plantationStep = 3;
        Firebase.setInt(firebaseData, "/rover/plantation/current_step", 3);
      }
      break;
      
    case 3:
      if (elapsed >= 500) {
        Serial.println("Step 3/5: Flap OPEN (sensor immersed) ğŸ“");
        flapServo.write(90);
        soilMoistureReading = readSoilMoisture();
        Serial.printf("   â””â”€ Soil moisture: %.1f%%\n", soilMoistureReading);
        calculateWaterDuration();
        sequenceStartTime = millis();
        plantationStep = 4;
        Firebase.setInt(firebaseData, "/rover/plantation/current_step", 4);
      }
      break;
      
    case 4:
      if (elapsed >= 8000) {
        Serial.println("Step 4/5: Flap CLOSE ğŸ”’");
        flapServo.write(0);
        sequenceStartTime = millis();
        plantationStep = 5;
        Firebase.setInt(firebaseData, "/rover/plantation/current_step", 5);
      }
      break;
      
    case 5:
      if (elapsed >= 500) {
        Serial.println("Step 5/5: Rack UP â†‘");
        moveRackUp();
        sequenceStartTime = millis();
        plantationStep = 6;
      }
      break;
      
    case 6:
      if (elapsed >= 2000) {
        Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        Serial.println("â•‘  PLANTATION COMPLETE âœ“             â•‘");
        Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
        stopMotors();
        plantationRunning = false;
        plantationStep = 0;
        Firebase.setBool(firebaseData, "/rover/plantation/sequence_running", false);
        Firebase.setFloat(firebaseData, "/rover/plantation/water_duration_calculated", calculatedWaterDuration);
      }
      break;
  }
}

void startIrrigationSequence() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘      IRRIGATION STARTED            â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.printf("ğŸ’§ Watering for %.1f seconds\n", calculatedWaterDuration / 1000.0);
  
  irrigationRunning = true;
  digitalWrite(PUMP_RELAY_PIN, HIGH);
  sequenceStartTime = millis();
  
  Firebase.setBool(firebaseData, "/rover/plantation/irrigation_active", true);
}

void runIrrigationSequence() {
  unsigned long elapsed = millis() - sequenceStartTime;
  
  if (elapsed >= calculatedWaterDuration) {
    Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘   IRRIGATION COMPLETE âœ“            â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    digitalWrite(PUMP_RELAY_PIN, LOW);
    irrigationRunning = false;
    Firebase.setBool(firebaseData, "/rover/plantation/irrigation_active", false);
  }
}

void moveRackDown() {
  digitalWrite(MOTOR_A_FWD, LOW);
  digitalWrite(MOTOR_A_BWD, HIGH);
  digitalWrite(MOTOR_B_FWD, HIGH);
  digitalWrite(MOTOR_B_BWD, LOW);
  analogWrite(MOTOR_ENA, 255);
  analogWrite(MOTOR_ENB, 255);
}

void moveRackUp() {
  digitalWrite(MOTOR_A_FWD, HIGH);
  digitalWrite(MOTOR_A_BWD, LOW);
  digitalWrite(MOTOR_B_FWD, LOW);
  digitalWrite(MOTOR_B_BWD, HIGH);
  analogWrite(MOTOR_ENA, 255);
  analogWrite(MOTOR_ENB, 255);
}

void stopMotors() {
  digitalWrite(MOTOR_A_FWD, LOW);
  digitalWrite(MOTOR_A_BWD, LOW);
  digitalWrite(MOTOR_B_FWD, LOW);
  digitalWrite(MOTOR_B_BWD, LOW);
}

void rotateDisc60Degrees() {
  discServo.write(180);
  delay(300);
  discServo.write(90);
  currentDiscAngle = (currentDiscAngle + 60) % 360;
}

void calculateWaterDuration() {
  // Load thresholds from Firebase matching YOUR database structure
  String basePath = "/crops/" + selectedCrop + "/stages/" + selectedStage;
  
  if (Firebase.getFloat(firebaseData, basePath + "/moisture_min")) {
    currentThresholds.moisture_min = firebaseData.floatData();
  }
  if (Firebase.getFloat(firebaseData, basePath + "/moisture_max")) {
    currentThresholds.moisture_max = firebaseData.floatData();
  }
  
  float targetMoisture = (currentThresholds.moisture_min + currentThresholds.moisture_max) / 2.0;
  float deficit = targetMoisture - soilMoistureReading;
  
  if (deficit <= 0) {
    Serial.println("   â””â”€ Soil moisture adequate, no watering needed");
    calculatedWaterDuration = 0;
    return;
  }
  
  // Pump: 100 L/H = 0.028 L/sec
  // 1% moisture â‰ˆ 50ml water
  float waterNeeded = deficit * 0.05;
  float pumpRate = 0.028;
  calculatedWaterDuration = (waterNeeded / pumpRate) * 1000;
  
  calculatedWaterDuration = constrain(calculatedWaterDuration, 1000, 30000);
  
  Serial.printf("   â””â”€ Water needed: %.1fs (deficit: %.1f%%)\n", 
                calculatedWaterDuration / 1000.0, deficit);
}
