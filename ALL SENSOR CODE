#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>

// -------------------- PIN DEFINITIONS --------------------
#define SOIL_PIN   34      // Your soil moisture ADC pin
#define DHTPIN     4       // DHT22 data pin
#define DHTTYPE    DHT22   // DHT22 sensor

// OLED
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET   -1
#define OLED_ADDR    0x3C

// Objects
DHT dht(DHTPIN, DHTTYPE);
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// Variables
int soilRaw = 0;
int soilPercent = 0;

void setup() {
  Serial.begin(115200);
  Serial.println("ESP32 - Soil + DHT22 + OLED");
  delay(1500);

  // ADC resolution identical to your program
  analogReadResolution(12);  // 0â€“4095

  dht.begin();

  Wire.begin(21, 22); // SDA, SCL for OLED

  if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDR)) {
    Serial.println("OLED INIT FAILED!");
    while (1);
  }

  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.println("System Starting...");
  display.display();
  delay(1200);
}

void loop() {

  // ---------------- SOIL SENSOR (YOUR EXACT CODE) ----------------
  soilRaw = analogRead(SOIL_PIN);
  Serial.println(String("Soil Val: ") + soilRaw);

  // EXACT mapping from your sample code:
  soilPercent = map(soilRaw, 4095, 1490, 0, 100);

  // Clamp range
  if (soilPercent < 0) soilPercent = 0;
  if (soilPercent > 100) soilPercent = 100;

  Serial.println(String("Value after mapped: ") + soilPercent);

  // Soil status
  String soilStatus;
  if (soilPercent >= 80) soilStatus = "Enough Water";
  else if (soilPercent <= 40) soilStatus = "Low Water";
  else soilStatus = "Okay";

  // ---------------- DHT22 SENSOR ----------------
  float h = dht.readHumidity();
  float t = dht.readTemperature();

  if (isnan(h) || isnan(t)) {
    Serial.println("DHT22 READ ERROR!");
  }

  // ---------------- OLED DISPLAY ----------------
  display.clearDisplay();
  display.setTextSize(1);

  display.setCursor(0, 0);
  display.println("SMART FARM MONITOR");

  display.setCursor(0, 12);
  display.print("Temp: ");
  display.print(t, 1);
  display.print((char)247);
  display.println("C");

  display.setCursor(0, 24);
  display.print("Hum : ");
  display.print(h, 1);
  display.println("%");

  display.setCursor(0, 36);
  display.print("Soil: ");
  display.print(soilPercent);
  display.println("%");

  display.setCursor(0, 48);
  display.print("Status: ");
  display.print(soilStatus);

  display.display();

  delay(2000);
}
