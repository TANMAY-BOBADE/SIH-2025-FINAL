#include <WiFi.h>
#include <DHT.h>
#include <FirebaseESP32.h>

// =================== WIFI CREDENTIALS ===================
const char* ssid = "wifi";          
const char* password = "12345678";  

// =================== FIREBASE CONFIG ===================
#define DATABASE_URL "https://kissan-agriculture-sih-default-rtdb.asia-southeast1.firebasedatabase.app"
#define DATABASE_SECRET "RudAdT0IW4GEPXx3kT8SH0CoqqpQYjC9ItfkNzdS"

// =================== HARDWARE PINS ===================
#define SOIL_ADC_PIN 34    
#define DHT_PIN 4          
#define RELAY_PIN 26   //in1   

#define DHT_TYPE DHT22

// =================== SETTINGS ===================
#define RELAY_ON_LOGIC HIGH  
#define RELAY_OFF_LOGIC LOW

const int AIR_VALUE = 3200;   
const int WATER_VALUE = 2670; 

// =================== OBJECTS ===================
DHT dht(DHT_PIN, DHT_TYPE);
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

// =================== VARIABLES ===================
bool isAutoMode = false;
String lastManualCommand = "CLOSE";
unsigned long lastSensorUpdate = 0;
unsigned long lastAutoCheck = 0;
unsigned long lastCommandCheck = 0;
int dhtFailCount = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  Serial.println("ğŸ’§ Smart Drip Irrigation System v2.0");
  Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

  // 1. HARDWARE INIT
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, RELAY_OFF_LOGIC);
  Serial.println("âœ… Relay: Valve CLOSED");

  pinMode(DHT_PIN, INPUT_PULLUP);
  dht.begin();
  delay(2000);
  Serial.println("âœ… DHT22: Initialized");

  // 2. WIFI
  Serial.print("ğŸ“¡ WiFi: Connecting");
  WiFi.begin(ssid, password);
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println(" CONNECTED");
    Serial.print("ğŸ“ IP: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println(" FAILED!");
  }

  // 3. FIREBASE
  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;
  firebaseData.setBSSLBufferSize(2048, 1024);
  firebaseData.setResponseSize(2048);
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  Serial.println("âœ… Firebase: Connected");

  // 4. INITIAL STATE
  Firebase.setString(firebaseData, "/irrigation/valve/state", "CLOSED");
  Firebase.setString(firebaseData, "/irrigation/valve/command", "CLOSE");
  
  Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  Serial.println("ğŸš€ System Ready!\n");
}

void loop() {
  unsigned long currentMillis = millis();

  // WiFi check
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âš ï¸  WiFi lost! Reconnecting...");
    WiFi.reconnect();
    delay(5000);
    return;
  }

  // 1. CHECK MODE & COMMANDS (every 500ms)
  if (Firebase.ready() && (currentMillis - lastCommandCheck > 500)) {
    lastCommandCheck = currentMillis;
    checkSystemMode();
  }

  // 2. SENSOR UPLOAD (every 5 seconds)
  if (currentMillis - lastSensorUpdate > 5000) {
    lastSensorUpdate = currentMillis;
    updateSensors();
  }

  delay(10);
}

// ============================================================
// MODE CONTROLLER
// ============================================================
void checkSystemMode() {
  if (Firebase.getString(firebaseData, "/irrigation/crop_intelligence/status")) {
    String status = firebaseData.stringData();
    bool newAutoMode = (status == "ON");
    
    if (newAutoMode != isAutoMode) {
      isAutoMode = newAutoMode;
      Serial.println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
      if (isAutoMode) {
        Serial.println("ğŸ§  AUTO MODE: Crop Intelligence ENABLED");
        Serial.println("   System will control valve automatically");
      } else {
        Serial.println("ğŸ® MANUAL MODE: User control ENABLED");
        Serial.println("   Valve controlled from dashboard");
      }
      Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    }
  }

  if (isAutoMode) {
    runAutoIntelligence();
  } else {
    runManualMode();
  }
}

// ============================================================
// AUTO MODE (CROP INTELLIGENCE)
// ============================================================
void runAutoIntelligence() {
  if (millis() - lastAutoCheck < 5000) return;
  lastAutoCheck = millis();

  Serial.println("ğŸ§  Crop Intelligence Check...");

  // 1. Get Crop & Stage
  String crop = "", stage = "";
  if (Firebase.getString(firebaseData, "/irrigation/selected_crop")) {
    crop = firebaseData.stringData();
  }
  if (Firebase.getString(firebaseData, "/irrigation/selected_stage")) {
    stage = firebaseData.stringData();
  }

  if (crop == "" || stage == "") {
    Serial.println("âš ï¸  No crop selected. Paused.\n");
    return;
  }

  // 2. Fetch Threshold
  String path = "/crops/" + crop + "/stages/" + stage + "/moisture_min";
  float minMoisture = 0;

  if (Firebase.getFloat(firebaseData, path)) {
    minMoisture = firebaseData.floatData();
  } else {
    Serial.println("âŒ Failed to fetch threshold");
    Serial.println("   Path: " + path + "\n");
    return;
  }

  // 3. Read Moisture
  float m = readMoisture();
  
  // 4. Display & Decide
  Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
  Serial.printf("â”‚ Crop: %-28s â”‚\n", crop.c_str());
  Serial.printf("â”‚ Stage: %-27s â”‚\n", stage.c_str());
  Serial.println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
  Serial.printf("â”‚ Target Min: %.1f%%%-18sâ”‚\n", minMoisture, "");
  Serial.printf("â”‚ Current: %.1f%%%-21sâ”‚\n", m, "");
  Serial.printf("â”‚ Status: %-26s â”‚\n", (m < minMoisture) ? "NEEDS WATER" : "SUFFICIENT");
  Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");

  // Hysteresis: ON < min, OFF > min+5
  if (m < minMoisture) {
    Serial.println("ğŸ’§ Action: Opening valve\n");
    openValve();
  } 
  else if (m > (minMoisture + 5)) {
    Serial.println("âœ… Action: Closing valve\n");
    closeValve();
  } else {
    Serial.println("â¸ï¸  Action: No change (hysteresis)\n");
  }
}

// ============================================================
// MANUAL MODE
// ============================================================
void runManualMode() {
  if (Firebase.getString(firebaseData, "/irrigation/valve/command")) {
    String cmd = firebaseData.stringData();
    
    if (cmd != lastManualCommand) {
      lastManualCommand = cmd;
      Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
      Serial.println("ğŸ® MANUAL COMMAND: " + cmd);
      
      if (cmd == "OPEN") {
        openValve();
      } else if (cmd == "CLOSE") {
        closeValve();
      }
      Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    }
  }
}

// ============================================================
// VALVE CONTROL
// ============================================================
void openValve() {
  digitalWrite(RELAY_PIN, RELAY_ON_LOGIC);
  Firebase.setString(firebaseData, "/irrigation/valve/state", "OPEN");
  Firebase.setInt(firebaseData, "/irrigation/valve/last_changed", millis());
  Serial.println("   ğŸš° Valve: OPEN");
}

void closeValve() {
  digitalWrite(RELAY_PIN, RELAY_OFF_LOGIC);
  Firebase.setString(firebaseData, "/irrigation/valve/state", "CLOSED");
  Firebase.setInt(firebaseData, "/irrigation/valve/last_changed", millis());
  Serial.println("   ğŸš« Valve: CLOSED");
}

// ============================================================
// SENSOR FUNCTIONS (CRITICAL FIX)
// ============================================================
void updateSensors() {
  // Read DHT with retry
  float h = dht.readHumidity();
  float t = dht.readTemperature();
  
  if (isnan(h) || isnan(t)) {
    delay(100);
    h = dht.readHumidity();
    t = dht.readTemperature();
  }

  // ALWAYS read moisture (most important!)
  float m = readMoisture();

  // âœ… CRITICAL FIX: Upload moisture REGARDLESS of DHT status
  if (isnan(h) || isnan(t)) {
    dhtFailCount++;
    
    // Upload with default DHT values
    Firebase.setFloat(firebaseData, "/irrigation/sensors/temperature", 0);
    Firebase.setFloat(firebaseData, "/irrigation/sensors/humidity", 0);
    Firebase.setFloat(firebaseData, "/irrigation/sensors/moisture", m);
    Firebase.setInt(firebaseData, "/irrigation/sensors/timestamp", millis());
    
    // Print warning periodically
    if (dhtFailCount % 10 == 1) {
      Serial.printf("âš ï¸  DHT offline (%d fails) | Moisture: %.1f%%\n", dhtFailCount, m);
    } else {
      Serial.printf("ğŸ“Š M: %.1f%% (DHT offline)\n", m);
    }
    return;
  }

  // DHT working - reset counter
  if (dhtFailCount > 0) {
    Serial.println("âœ… DHT recovered!");
    dhtFailCount = 0;
  }

  // Upload all data
  Firebase.setFloat(firebaseData, "/irrigation/sensors/temperature", t);
  Firebase.setFloat(firebaseData, "/irrigation/sensors/humidity", h);
  Firebase.setFloat(firebaseData, "/irrigation/sensors/moisture", m);
  Firebase.setInt(firebaseData, "/irrigation/sensors/timestamp", millis());

  Serial.printf("ğŸ“Š T: %.1fÂ°C | H: %.1f%% | M: %.1f%%\n", t, h, m);
}

float readMoisture() {
  // Average 5 readings
  float total = 0;
  for (int i = 0; i < 5; i++) {
    total += analogRead(SOIL_ADC_PIN);
    delay(10);
  }
  float raw = total / 5.0;
  float percent = map(raw, AIR_VALUE, WATER_VALUE, 0, 100);
  return constrain(percent, 0, 100);
}
