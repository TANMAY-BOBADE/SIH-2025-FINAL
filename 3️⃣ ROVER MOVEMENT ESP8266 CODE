#include <ESP8266WiFi.h>
#include <FirebaseESP8266.h>

// =================== WIFI CREDENTIALS ===================
const char* ssid = "wifi";
const char* password = "12345678";

// =================== FIREBASE ===================
#define DATABASE_URL "https://kissan-agriculture-sih-default-rtdb.asia-southeast1.firebasedatabase.app"
#define DATABASE_SECRET "RudAdT0IW4GEPXx3kT8SH0CoqqpQYjC9ItfkNzdS"

// =================== MOTOR PINS ===================
// NOTE: if ENA (D0) gives trouble with speed control, move it to D6
#define ENA D5 
#define IN1 D4
#define IN2 D3
#define IN3 D2
#define IN4 D1
#define ENB D0

// =================== OBJECTS ===================
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

// =================== VARIABLES ===================
int motorSpeed = 220; // Increased to 220/255 for better torque
String lastCommand = "STOP";
unsigned long lastFailTime = 0;

void setup() {
  Serial.begin(9600);
  
  // OPTIMIZATION 1: Fix PWM Range to 0-255 (Default is 1023)
  analogWriteRange(255);
  
  pinMode(ENA, OUTPUT); pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT); pinMode(ENB, OUTPUT);
  stopMotors();

  // OPTIMIZATION 2: Disable WiFi Sleep to prevent lag spikes
  WiFi.setSleepMode(WIFI_NONE_SLEEP);
  WiFi.begin(ssid, password);
  
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(200);
    Serial.print(".");
  }
  Serial.println("\nWiFi Connected");

  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;
  
  // OPTIMIZATION 3: Faster Firebase buffer settings
  firebaseData.setBSSLBufferSize(1024, 1024);
  firebaseData.setResponseSize(1024);

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
}

void loop() {
  // OPTIMIZATION 4: Removed the 300ms delay. We check as fast as network allows.
  // We use get to check status immediately.
  
  if (WiFi.status() == WL_CONNECTED && Firebase.ready()) {
    // We check the command. 
    // Note: If you want 'Stream' (Push) for absolute 0ms latency, 
    // it requires different logic, but this 'aggressive polling' is robust.
    if (Firebase.getString(firebaseData, "/rover/controls/movement")) {
      String command = firebaseData.stringData();
      if (command != lastCommand) {
        lastCommand = command;
        executeCommand(command);
      }
    }
  }
}

void executeCommand(String command) {
  // Debugging: Print exactly what we received so you can see it in Serial Monitor
  Serial.print("Received Command: ");
  Serial.println(command);

  // Accept "FORWARD" (from code) OR "UP" (from dashboard arrows)
  if (command == "FORWARD" || command == "UP") {
    moveForward();
  } 
  // Accept "BACKWARD" (from code) OR "DOWN" (from dashboard arrows)
  else if (command == "BACKWARD" || command == "DOWN") {
    moveBackward();
  } 
  else if (command == "LEFT") {
    turnLeft();
  } 
  else if (command == "RIGHT") {
    turnRight();
  } 
  else if (command == "STOP") {
    stopMotors();
  }
  else {
    // If we get weird junk data, stop just in case
    stopMotors();
  }
}

void moveForward() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
  analogWrite(ENA, motorSpeed); analogWrite(ENB, motorSpeed);
}

void moveBackward() {
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
  analogWrite(ENA, motorSpeed); analogWrite(ENB, motorSpeed);
}

void turnLeft() {
  // Spot turn (motors spin opposite directions)


    digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
  analogWrite(ENA, motorSpeed); analogWrite(ENB, motorSpeed);
}

void turnRight() {
  // Spot turn
    digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
  analogWrite(ENA, motorSpeed); analogWrite(ENB, motorSpeed);

}

void stopMotors() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
  analogWrite(ENA, 0); analogWrite(ENB, 0);
}
