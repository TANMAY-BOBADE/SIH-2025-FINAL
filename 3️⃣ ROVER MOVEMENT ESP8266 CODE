#include <ESP8266WiFi.h>
#include <FirebaseESP8266.h>

// =================== WIFI CREDENTIALS (YOUR MOBILE HOTSPOT) ===================
const char* ssid = "YOUR_MOBILE_HOTSPOT_NAME";     // Change this!
const char* password = "YOUR_HOTSPOT_PASSWORD";    // Change this!

// =================== FIREBASE ===================
#define DATABASE_URL "https://kissan-agriculture-sih-default-rtdb.asia-southeast1.firebasedatabase.app"
#define DATABASE_SECRET "YOUR_DATABASE_SECRET_HERE"

// =================== MOTOR PINS ===================
#define ENA D0
#define IN1 D1
#define IN2 D2
#define IN3 D3
#define IN4 D4
#define ENB D5

// =================== OBJECTS ===================
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

// =================== VARIABLES ===================
int motorSpeed = 200;
String lastCommand = "STOP";
unsigned long lastCommandCheck = 0;
const unsigned long COMMAND_CHECK_INTERVAL = 300; // Check every 0.3 seconds

void setup() {
  Serial.begin(9600);
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘   ROVER MOVEMENT CONTROLLER        â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  // Initialize motor pins
  pinMode(ENA, OUTPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  pinMode(ENB, OUTPUT);
  
  stopMotors();
  
  // Connect to mobile hotspot
  Serial.println("\nğŸ“± Connecting to mobile hotspot...");
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ“ WiFi Connected!");
    Serial.print("âœ“ IP Address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nâœ— WiFi connection failed!");
    Serial.println("âš ï¸ Check hotspot name and password!");
  }
  
  // Initialize Firebase
  Serial.println("ğŸ”¥ Initializing Firebase...");
  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;
  
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  
  if (Firebase.setString(firebaseData, "/rover/movement_module", "ONLINE")) {
    Serial.println("âœ“ Firebase connected!");
  } else {
    Serial.println("âœ— Firebase failed: " + firebaseData.errorReason());
  }
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘         SYSTEM READY               â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
  unsigned long currentMillis = millis();
  
  // Check WiFi connection
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âš ï¸ WiFi disconnected! Reconnecting...");
    WiFi.reconnect();
    delay(5000);
  }
  
  // Check Firebase for movement commands
  if (currentMillis - lastCommandCheck >= COMMAND_CHECK_INTERVAL) {
    lastCommandCheck = currentMillis;
    checkMovementCommands();
  }
  
  delay(10);
}

void checkMovementCommands() {
  // Read movement command from Firebase
  if (Firebase.getString(firebaseData, "/rover/controls/movement")) {
    String command = firebaseData.stringData();
    
    // Only execute if command changed
    if (command != lastCommand) {
      lastCommand = command;
      executeCommand(command);
    }
  }
}

void executeCommand(String command) {
  Serial.println("Command: " + command);
  
  if (command == "FORWARD") {
    moveForward();
  } else if (command == "BACKWARD") {
    moveBackward();
  } else if (command == "LEFT") {
    turnLeft();
  } else if (command == "RIGHT") {
    turnRight();
  } else if (command == "STOP") {
    stopMotors();
  }
}

void moveForward() {
  Serial.println("â†’ Moving FORWARD");
  analogWrite(ENA, motorSpeed);
  analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
}

void moveBackward() {
  Serial.println("â† Moving BACKWARD");
  analogWrite(ENA, motorSpeed);
  analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
}

void turnLeft() {
  Serial.println("â†º Turning LEFT");
  analogWrite(ENA, motorSpeed);
  analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
}

void turnRight() {
  Serial.println("â†» Turning RIGHT");
  analogWrite(ENA, motorSpeed);
  analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
}

void stopMotors() {
  Serial.println("â¹ STOP");
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
}
