#include <ESP8266WiFi.h>
#include <FirebaseESP8266.h>

// =================== 1. PHONE HOTSPOT CREDENTIALS ===================
const char* ssid = "YOUR_HOTSPOT_NAME";
const char* password = "YOUR_HOTSPOT_PASSWORD";

// =================== 2. FIREBASE CONFIG ===================
#define DATABASE_URL "https://kissan-agriculture-sih-default-rtdb.asia-southeast1.firebasedatabase.app"
#define DATABASE_SECRET "YOUR_DATABASE_SECRET_HERE"

// =================== MOTOR PINS (L298N) ===================
#define ENA D0
#define IN1 D1
#define IN2 D2
#define IN3 D3
#define IN4 D4
#define ENB D5

// =================== OBJECTS ===================
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

String currentDirection = "STOP";
int motorSpeed = 255; // Max Speed

void setup() {
  Serial.begin(9600);
  Serial.println("\n===== ROVER MOVEMENT CONTROLLER =====");
  
  // Init Pins
  pinMode(ENA, OUTPUT); pinMode(ENB, OUTPUT);
  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);
  stopMotors();

  // Connect to Phone Hotspot
  WiFi.begin(ssid, password);
  Serial.print("Connecting to Hotspot");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ“ Connected to Internet!");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());

  // Init Firebase
  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  Serial.println("ðŸ”¥ Firebase Initialized");
}

void loop() {
  // Listen for Movement Command from Dashboard
  // Path: /rover/controls/movement
  if (Firebase.getString(firebaseData, "/rover/controls/movement")) {
    String newDirection = firebaseData.stringData();
    
    // Only act if direction changed to prevent stuttering
    if (newDirection != currentDirection) {
      currentDirection = newDirection;
      Serial.println("Command: " + currentDirection);
      
      if (currentDirection == "UP") moveForward();
      else if (currentDirection == "DOWN") moveBackward();
      else if (currentDirection == "LEFT") turnLeft();
      else if (currentDirection == "RIGHT") turnRight();
      else stopMotors();
    }
  } else {
      // If error or empty, stop for safety
      // stopMotors(); 
  }
}

// =================== MOTOR FUNCTIONS ===================
void moveForward() {
  analogWrite(ENA, motorSpeed); analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void moveBackward() {
  analogWrite(ENA, motorSpeed); analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
}

void turnLeft() {
  analogWrite(ENA, motorSpeed); analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void turnRight() {
  analogWrite(ENA, motorSpeed); analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
}

void stopMotors() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
}
